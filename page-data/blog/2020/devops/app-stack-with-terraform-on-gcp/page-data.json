{"componentChunkName":"component---src-layouts-blog-post-tsx","path":"/blog/2020/devops/app-stack-with-terraform-on-gcp","result":{"data":{"site":{"siteMetadata":{"siteUrl":"https://andri.dk","title":"andri.dk","description":"I make websites, create apps, manage infrastructure, develop products and more.","social":{"twitter":"andrioid"}}},"markdownRemark":{"html":"<p>In this series, we are going to setup continuous deployment on Github Actions that will deploy a full environment in the cloud. Then we will setup a scheduled action to tear it all down, if we're not using it.</p>\n<ul>\n<li>Part 1: Covers the infrastructure setup and backend</li>\n<li>Part 2: Covers Github Actions</li>\n</ul>\n<blockquote>\n<p>Note: While this is perfectly fine for development-environments, you should probably NOT do this in production.</p>\n</blockquote>\n<h2 id=\"motivation\" style=\"position:relative;\"><a href=\"#motivation\" aria-label=\"motivation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Motivation</h2>\n<p>I didn't like paying for hosting on projects that I rarely have time to work on. So, I figured that if I could describe my environment decleratively, then I could just create automatically when I need it, and delete it automatically when I don't.</p>\n<h2 id=\"before-we-begin\" style=\"position:relative;\"><a href=\"#before-we-begin\" aria-label=\"before we begin permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Before we begin</h2>\n<p>You will need a few things before we get started.</p>\n<ul>\n<li>A Google Cloud account</li>\n<li>A Google Cloud project</li>\n<li>Terraform installed</li>\n<li>A <a href=\"https://cloud.google.com/iam/docs/creating-managing-service-account-keys\">service-account</a> with a JSON key file.</li>\n<li>The following roles on your service-account: Cloud Build Service Account, Cloud Build Editor, Cloud SQL Admin, Editor, Service Account User, Cloud, Run Admin, Storage Admin</li>\n</ul>\n<p>When you have the JSON key file, you can add it to an environmental variable while you work with Terraform. If you forget to add this to ENV, then Terraform won't be able to talk to GCP.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"command-line-prompt\"><span data-user=groot data-host=localhost></span></span><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">GOOGLE_CREDENTIALS</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">cat</span> ~/Downloads/path-to-my-secret-service-account.json<span class=\"token variable\">)</span></span></code></pre></div>\n<blockquote>\n<p>Note: We are giving this service-account some pretty broad permissions on our project. So, be careful of not putting the file into Git or anything like that. I also recommend trimming these permissions manually.</p>\n</blockquote>\n<h2 id=\"describing-our-environment\" style=\"position:relative;\"><a href=\"#describing-our-environment\" aria-label=\"describing our environment permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Describing our environment</h2>\n<p>Hashicorp's Terraform is \"infrastructure as code\", or as I would put it: \"A declaritive way of describing your hosting environment\". Instead of telling Google or Amazon what to do, we tell Terraform how it should look like. Terraform then does the required API calls, and if everything is as it should be, it will do nothing at all.</p>\n<p>This may seem overly complicated, but by doing this, copying an environment is trivial. If there's a new person on your team that wants to know what environments are running, we can look in one place.</p>\n<p>We will be deploying:</p>\n<ul>\n<li>a Postgres database</li>\n<li>a storage bucket</li>\n<li>a managed container with a Go backend</li>\n</ul>\n<h3 id=\"initial-terraform-configuration\" style=\"position:relative;\"><a href=\"#initial-terraform-configuration\" aria-label=\"initial terraform configuration permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Initial Terraform configuration</h3>\n<p>Terraform configuration-files have a <code class=\"language-text\">.tf</code> postfix. To keep things simple, we'll only use one file (<code class=\"language-text\">main.tf</code>). The file is rather large, so we will start small and then add to it.</p>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">provider<span class=\"token type variable\"> \"google\" </span></span><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">project</span> <span class=\"token punctuation\">=</span> var.project\n  <span class=\"token property\">region</span>  <span class=\"token punctuation\">=</span> var.region\n  <span class=\"token property\">version</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"= 3.23\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This just tells Terraform that we'll be using the Google Cloud provider. We lock the version, so that our configuration file matches the provider API used.</p>\n<h3 id=\"persisting-our-state\" style=\"position:relative;\"><a href=\"#persisting-our-state\" aria-label=\"persisting our state permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Persisting our state</h3>\n<p>If you run Terraform locally, you might notice a <code class=\"language-text\">.tfstate</code> file. It tells Terraform which services are already created, their last known configuration and so on. We will be using Terraform as a part of our builds, so we want this state to be persisted somewhere globally.</p>\n<p>To be able to do that, you need to manually create a bucket called <code class=\"language-text\">tfstate.internal.example.com</code> (or whatever you want, just make it match the configuration below) in your Google Cloud project.</p>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">terraform</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">backend<span class=\"token type variable\"> \"gcs\" </span></span><span class=\"token punctuation\">{</span>\n    <span class=\"token property\">bucket</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"tfstate.internal.example.com\"</span>\n    <span class=\"token property\">prefix</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"terraform/state\"</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<blockquote>\n<p>Note: The Terraform state bucket cannot be managed by Terraform. You must create it yourself.</p>\n</blockquote>\n<h3 id=\"variables\" style=\"position:relative;\"><a href=\"#variables\" aria-label=\"variables permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Variables</h3>\n<p>Using variables allow us to define stuff like \"region\" and \"database_secret\" in one place. Terraform variables can also be set using ENV, like \"TF_VAR_REGION\" will be matched to a \"region\" variable.</p>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">variable<span class=\"token type variable\"> \"region\" </span></span><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">type</span>        <span class=\"token punctuation\">=</span> string\n  <span class=\"token property\">description</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"GCP region\"</span>\n  <span class=\"token property\">default</span>     <span class=\"token punctuation\">=</span> <span class=\"token string\">\"europe-west1\"</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">variable<span class=\"token type variable\"> \"project\" </span></span><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">type</span>        <span class=\"token punctuation\">=</span> string\n  <span class=\"token property\">description</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"GCP project\"</span>\n  <span class=\"token property\">default</span>     <span class=\"token punctuation\">=</span> <span class=\"token string\">\"example-project\"</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\"># Used by our non-root database user</span>\n<span class=\"token keyword\">variable<span class=\"token type variable\"> \"db_password\" </span></span><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">type</span>        <span class=\"token punctuation\">=</span> string\n  <span class=\"token property\">description</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"Database secret\"</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\"># Used by our deployment pipeline to set the new image.</span>\n<span class=\"token keyword\">variable<span class=\"token type variable\"> \"docker_tag\" </span></span><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">type</span>        <span class=\"token punctuation\">=</span> string\n  <span class=\"token property\">description</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"Tag for Docker Image\"</span>\n  <span class=\"token property\">default</span>     <span class=\"token punctuation\">=</span> <span class=\"token string\">\"latest\"</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<h3 id=\"adding-the-database\" style=\"position:relative;\"><a href=\"#adding-the-database\" aria-label=\"adding the database permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Adding the database</h3>\n<p>Since this is just a teeny tiny staging environment, we buy the cheapest database server around. We are using Postgres 11, there are also <a href=\"https://www.terraform.io/docs/providers/google/r/sql_database_instance.html\">other database types and options</a>.</p>\n<blockquote>\n<p>Note: We will be destroying our database periodically, so if you need to store something permenently, you should do backups.</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">resource <span class=\"token type variable\">\"google_sql_database_instance\"</span></span> <span class=\"token string\">\"db\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">name</span>             <span class=\"token punctuation\">=</span> <span class=\"token string\">\"db\"</span>\n  <span class=\"token property\">region</span>           <span class=\"token punctuation\">=</span> var.region\n  <span class=\"token property\">database_version</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"POSTGRES_11\"</span>\n  <span class=\"token keyword\">settings</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">tier</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"db-f1-micro\"</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">resource <span class=\"token type variable\">\"google_sql_database\"</span></span> <span class=\"token string\">\"dbname\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">name</span>     <span class=\"token punctuation\">=</span> <span class=\"token string\">\"staging\"</span>\n  <span class=\"token property\">instance</span> <span class=\"token punctuation\">=</span> google_sql_database_instance.db.name\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">resource <span class=\"token type variable\">\"google_sql_user\"</span></span> <span class=\"token string\">\"dbuser\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">name</span>     <span class=\"token punctuation\">=</span> <span class=\"token string\">\"pgadmin\"</span>\n  <span class=\"token property\">instance</span> <span class=\"token punctuation\">=</span> google_sql_database_instance.db.name\n  <span class=\"token property\">password</span> <span class=\"token punctuation\">=</span> var.db_password\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>You will notice that we are referencing our variables (like <code class=\"language-text\">var.db_password</code>), but we're also referencing the resources controlled by Terraform. In this case, we fetch the instance-name from the newly created instance. In a normal setup, we'd have to know this information to be able to proceed. By using Terraform, it manages all of these references for us.</p>\n<h3 id=\"adding-a-storage-bucket-for-assets\" style=\"position:relative;\"><a href=\"#adding-a-storage-bucket-for-assets\" aria-label=\"adding a storage bucket for assets permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Adding a storage bucket for assets</h3>\n<p>My application uses <a href=\"https://gocloud.dev\">Go Cloud Development Kit</a> to store assets. And on Google Cloud, that means adding a Cloud Storage bucket to the project. At the moment, this bucket is private. Check the <a href=\"https://www.terraform.io/docs/providers/google/r/storage_bucket_access_control.html\">documentation</a> if you want a public bucket.</p>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">resource <span class=\"token type variable\">\"google_storage_bucket\"</span></span> <span class=\"token string\">\"assets\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">name</span>     <span class=\"token punctuation\">=</span> <span class=\"token string\">\"assets.example.com\"</span>\n  <span class=\"token property\">location</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"EU\"</span>\n  <span class=\"token comment\">#force_destroy = true # If you want this destroyed when we take our environment down, uncomment this line</span>\n  <span class=\"token property\">bucket_policy_only</span> <span class=\"token punctuation\">=</span> <span class=\"token boolean\">true</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"adding-a-cloud-run-service\" style=\"position:relative;\"><a href=\"#adding-a-cloud-run-service\" aria-label=\"adding a cloud run service permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Adding a cloud-run service</h3>\n<p>This guide is not going to cover building Docker images or creating Dockerfiles. In the second part of this guide, we will build a docker-image, push it to Container Registry and pass it on to Cloud Run.</p>\n<p>I was going to use Github Packages, but Cloud-Run only works from Google's Container Registry.</p>\n<p>For demonstration purposes, we are just using a sample image from Google, and the ENV variables will not be used. But I spent quite some time digging up how to make the SQL connection work, so I think leaving it in will be helpful The <code class=\"language-text\">metadata</code> part tells the Google SQL Proxy how to connect to the database and how many instances we will allow Google to scale to.</p>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">resource <span class=\"token type variable\">\"google_cloud_run_service\"</span></span> <span class=\"token string\">\"backend\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">name</span>     <span class=\"token punctuation\">=</span> <span class=\"token string\">\"backend\"</span>\n  <span class=\"token property\">location</span> <span class=\"token punctuation\">=</span> var.region\n\n  <span class=\"token keyword\">template</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">spec</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">containers</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">image</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"gcr.io/cloudrun/hello:<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">var</span><span class=\"token punctuation\">.</span><span class=\"token type variable\">docker_tag</span><span class=\"token punctuation\">}</span></span>\"</span>\n        <span class=\"token comment\"># Demonstration purposes only</span>\n        <span class=\"token keyword\">env</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token property\">name</span>  <span class=\"token punctuation\">=</span> <span class=\"token string\">\"PG_STRING\"</span>\n          <span class=\"token property\">value</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"host=/cloudsql/<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span>google_sql_database_instance<span class=\"token punctuation\">.</span>db<span class=\"token punctuation\">.</span>connection_name<span class=\"token punctuation\">}</span></span> user=<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span>google_sql_user<span class=\"token punctuation\">.</span>dbuser<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">}</span></span> password=<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span>google_sql_user<span class=\"token punctuation\">.</span>dbuser<span class=\"token punctuation\">.</span>password<span class=\"token punctuation\">}</span></span> dbname=<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span>google_sql_database<span class=\"token punctuation\">.</span>dbname<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">}</span></span> sslmode=require\"</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token comment\"># Demonstration purposes only</span>\n        <span class=\"token keyword\">env</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token property\">name</span>  <span class=\"token punctuation\">=</span> <span class=\"token string\">\"BUCKET\"</span>\n          <span class=\"token property\">value</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"gs://<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span>google_storage_bucket<span class=\"token punctuation\">.</span>assets<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">}</span></span>\"</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">metadata</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">annotations</span> <span class=\"token punctuation\">=</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"autoscaling.knative.dev/maxScale\"</span>      <span class=\"token punctuation\">=</span> <span class=\"token string\">\"3\"</span>\n        <span class=\"token property\">\"run.googleapis.com/cloudsql-instances\"</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">var</span><span class=\"token punctuation\">.</span><span class=\"token type variable\">project</span><span class=\"token punctuation\">}</span></span>:<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">var</span><span class=\"token punctuation\">.</span><span class=\"token type variable\">region</span><span class=\"token punctuation\">}</span></span>:<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span>google_sql_database_instance<span class=\"token punctuation\">.</span>db<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">}</span></span>\"</span>\n        <span class=\"token property\">\"run.googleapis.com/client-name\"</span>        <span class=\"token punctuation\">=</span> <span class=\"token string\">\"terraform\"</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token property\">autogenerate_revision_name</span> <span class=\"token punctuation\">=</span> <span class=\"token boolean\">true</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"custom-name-for-your-cloud-run-instance\" style=\"position:relative;\"><a href=\"#custom-name-for-your-cloud-run-instance\" aria-label=\"custom name for your cloud run instance permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Custom name for your Cloud Run instance</h3>\n<p>Google offers automatic TLS and load balancing with custom-names. First you have to validate your domain with Google, and then you have to <a href=\"https://cloud.google.com/run/docs/mapping-custom-domains#adding_verified_domain_owners_to_other_users_or_service_accounts\">add your service-account to it</a>.</p>\n<p>When that is done, you can use the following to add a custom dns name.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># https://cloud.google.com/run/docs/mapping-custom-domains#adding_verified_domain_owners_to_other_users_or_service_accounts\nresource &quot;google_cloud_run_domain_mapping&quot; &quot;backend&quot; {\n  location = var.region\n  name     = &quot;api.example.com&quot;\n\n  metadata {\n    namespace = var.project\n  }\n\n  spec {\n    route_name = google_cloud_run_service.backend.name\n  }\n}</code></pre></div>\n<h2 id=\"terraform-plan\" style=\"position:relative;\"><a href=\"#terraform-plan\" aria-label=\"terraform plan permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Terraform Plan</h2>\n<p>Navigate to your directory. I keep mine in <code class=\"language-text\">devops/google/main.tf</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"command-line-prompt\"><span data-user=groot data-host=localhost></span></span>terraform plan</code></pre></div>\n<h2 id=\"terraform-apply\" style=\"position:relative;\"><a href=\"#terraform-apply\" aria-label=\"terraform apply permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Terraform Apply</h2>\n<p>If you agree with the changes suggested by <code class=\"language-text\">terraform plan</code> you can run:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"command-line-prompt\"><span data-user=groot data-host=localhost></span></span>terraform apply</code></pre></div>\n<h2 id=\"terraform-destroy\" style=\"position:relative;\"><a href=\"#terraform-destroy\" aria-label=\"terraform destroy permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Terraform Destroy</h2>\n<p>To clean up all the resources we have created, we can run:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"command-line-prompt\"><span data-user=groot data-host=localhost></span></span>terraform destroy</code></pre></div>\n<blockquote>\n<p>Note: I don't take any responsibility for what you might leave on your account. So make sure that the cleanup worked as expected.</p>\n</blockquote>\n<h2 id=\"part-2-setting-this-up-on-github-actions\" style=\"position:relative;\"><a href=\"#part-2-setting-this-up-on-github-actions\" aria-label=\"part 2 setting this up on github actions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Part 2: Setting this up on Github Actions.</h2>\n<p>I'll add a link to the second part of this blog post as soon as it's ready.</p>","excerpt":"In this series, we are going to setup continuous deployment on Github Actions that will deploy a full environment in the cloud. Then we will setup a scheduled action to tear it all down, if we're not using it. Part 1: Covers the infrastructure setupâ€¦","fields":{"title":"Deploying a Full-Stack app on Google with Terraform","date":"2020-06-18T00:00:00.000Z","tags":["hosting","cloud"],"slug":"/blog/2020/devops/app-stack-with-terraform-on-gcp","socialcard":"gatsby-plugin-social-card/e00a0abd-10c6-5b53-a63f-14500c2196bf.jpg"},"frontmatter":{"date":"June 18, 2020","cover":null}}},"pageContext":{}},"staticQueryHashes":["2070580351"]}